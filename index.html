<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Spelling Worksheet ‚Äî 1‚Äì4 Syllables + Unified Sounds Folder</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }
  #stepsPanel { display: none !important; }

  html,body{height:100vh;margin:0;overflow:hidden;background:#f4f4f4}
  body{font-family:Arial,Helvetica,sans-serif;display:flex;align-items:flex-start;justify-content:center}
  #stage{transform-origin:top center;will-change:transform}

  .sheet{width:1100px;background:#fff;border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.12);
         margin-top:10px;padding:12px 12px 16px}
  .title{text-align:center;font-size:34px;font-weight:800;margin:8px 0 8px}

  .steps{border:2px solid #000;margin:6px 0 10px}
  .steps h3{margin:0;padding:6px 10px;border-bottom:2px solid #000;text-align:center;font-size:22px;font-weight:800}
  .steps .script{margin:10px 14px;line-height:1.55;font-size:18px}
  .steps .line{margin:4px 0}
  .steps .em{font-weight:700;text-decoration:underline}
  .steps .current{background:#fff8cc;border-radius:4px;padding:2px 4px}

  #instruction{font-size:18px;margin:10px 0 8px;min-height:28px}

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:7px 10px;font-size:14px;border:1px solid #cfcfcf;border-radius:5px;background:#1e9e47;color:#fff;cursor:pointer}
  button:hover{background:#17883c}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #restartBtn{background:#e33}
  .secondary{background:#495057}
  .secondary:hover{background:#3e464c}

  .lessonbar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:6px 0 2px;
  }
  .lessonbar label{font-size:14px;font-weight:700}
  .lessonbar select{
    padding:7px 10px; font-size:14px; border:1px solid #cfcfcf; border-radius:6px;
    background:#fff;
    min-width:260px;
  }
  .lessonbar .hint{
    font-size:12px; color:#555;
  }

  #studentLayout{margin-top:12px}

  .grid{border:2px solid #000}
  .hdr{display:grid}
  .hdr div{padding:8px 10px;font-weight:800;border-right:2px solid #000;text-align:left;font-size:18px}
  .hdr div:last-child{border-right:none}
  .row{display:grid}
  .row .cell{min-height:120px;border-top:2px solid #000;border-right:2px solid #000;position:relative;background:#fff}
  .row .cell:last-child{border-right:none}

  .syllableDrop{position:absolute;left:10px;bottom:12px;width:110px;height:74px;background:transparent}

  .tiles-row{display:grid;border-top:2px solid #000;background:#fff}
  .tiles{display:grid;grid-template-columns:repeat(6,1fr);gap:0;border-right:2px solid #000;padding:8px}
  .tiles:last-child{border-right:none}

  .counter-slot{
    position:relative;
    height:64px;
    background:transparent;
    border:none;
    border-left:1px dashed #cfd4da;
    overflow:visible;
  }
  .counter-slot:first-child{border-left:none}

  .counter-slot::after{
    content: attr(data-ord);
    position:absolute; top:2px; left:6px;
    font-size:11px; color:#88919a;
    pointer-events:none; user-select:none;
  }
  .counter-slot.has-counter::after{ color:#6b7280 }
  .counter-slot.disabled{ pointer-events:none; }
  .counter-slot.span-ghost{ pointer-events:none; }
  .counter-slot.span-ghost::after{ opacity:.15; }

  .counter.in-slot{
    position:absolute;
    top:26px;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:4;
  }

  .tile-label{
    position:absolute;
    bottom:6px;
    left:50%;
    transform:translateX(-50%);
    width:100%;
    margin:0;
    text-align:center;
    font-size:14px;
    font-weight:700;
    line-height:1;
    pointer-events:none;
    user-select:none;
    white-space:nowrap;
    z-index:3;
  }
  .tile-label.span2{
    left:100%;
    width:200%;
    transform:translateX(-50%);
  }

  .wholeword-write{padding:8px;display:flex;align-items:flex-start;justify-content:flex-start}
  #wholewordText{font-size:42px;font-weight:700;margin-top:6px}

  .counter-tray{display:flex;gap:8px;margin:12px 0 0;align-items:center;flex-wrap:wrap}
  .counter{width:26px;height:26px;border-radius:50%;background:#2d6cdf;cursor:grab}
  .counter.locked{cursor:not-allowed;}

  .syllableText{position:absolute;top:14px;left:0;right:0;text-align:center;font-size:40px;font-weight:700;pointer-events:none}

  .teacher-panel{
    position:fixed; right:12px; top:12px; width:960px; max-width:96vw; max-height:90vh;
    background:#fff; border:2px solid #000; border-radius:8px;
    box-shadow:0 6px 20px rgba(0,0,0,.18); padding:12px; display:none; z-index:9999; overflow:auto;
  }
  .teacher-panel h4{margin:0 0 8px; font-size:16px}
  .teacher-panel .hint{font-size:12px; color:#555; margin-top:6px}
  .teacher-panel .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:8px 0}
  .teacher-panel label{font-size:12px;display:block;margin:6px 0 2px}
  .teacher-panel input,.teacher-panel select,.teacher-panel textarea{
    padding:6px 8px; border:1px solid #bbb; border-radius:6px; font-size:14px
  }
  .teacher-panel textarea{width:100%; min-height:60px}
  .kbd{background:#eee;border:1px solid #bbb;border-bottom-color:#999;border-radius:4px;padding:0 4px;font:12px/1.4 monospace;color:#333}

  .tile-grid .tg-row{display:flex; gap:8px; align-items:center; margin:6px 0}
  .tile-grid .tg-title{width:86px; font-size:12px; font-weight:700}
  .tile-grid .tg-tiles{display:grid; grid-template-columns:repeat(6,1fr); gap:6px}
  .tile-grid input{padding:6px 8px; border:1px solid #bbb; border-radius:6px; font-size:14px}

  table.wordlist{width:100%; border-collapse:collapse; font-size:14px; margin-top:8px}
  .wordlist th,.wordlist td{border:1px solid #ccc; padding:6px; vertical-align:top}
  .wordlist th{background:#f7f7f7; position:sticky; top:0; z-index:1}
  .wordlist tr.selected{outline:2px solid #1e9e47}

  .teacher-hotspot{
    position: fixed; right: 8px; bottom: 8px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #000;
    opacity: .08;
    border: none;
    cursor: pointer;
  }
  .teacher-hotspot:hover{ opacity:.25; }

  .center,#criteria-container,#scenario-options,.output-container{display:none}

  .notes-card{border:1px dashed #bbb; border-radius:8px; padding:10px; background:#fafafa; flex:1; min-width:280px}
  .notes-card textarea{min-height:120px}

  .corner-glossary{
    position: sticky;
    top: 8px;
    margin-left: auto;
    max-width: 320px;
    background:#fff;
    border:1px solid #ddd;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    padding:10px 12px;
    font-size:12px;
    line-height:1.35;
  }
  .corner-glossary h5{
    margin:0 0 6px;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.03em;
  }
  .corner-glossary ul{
    list-style:disc;
    padding-left:18px;
    margin:6px 0 0;
    max-height:38vh;
    overflow:auto;
  }
  .corner-glossary li{ margin:2px 0; }
  .corner-glossary code{
    background:#f6f8fa;
    border:1px solid #e5e7eb;
    border-radius:4px;
    padding:0 4px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }

  .credits{position:fixed;right:12px;bottom:8px;font-size:11px;line-height:1.3;color:#555;pointer-events:none}
  .credits a{pointer-events:auto}
  .credits p{margin:2px 0}.credits p:first-child{color:#000;font-weight:bold}

  .counter,
  .counter-slot,
  .syllableDrop,
  #counters{
    touch-action:none;
    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
  }
</style>
</head>

<body>
<div id="stage">
  <div class="sheet">
    <div class="title">Spelling Worksheet</div>

    <div class="lessonbar">
      <label for="lessonSelect">Lesson set</label>
      <select id="lessonSelect"
              onchange="onLessonChange(this.value)"
              onfocus="prefetchLessonSilently(this.value)"
              onmouseover="prefetchLessonSilently(this.value)">
        <option value="">Choose a cycle/session‚Ä¶</option>
        <option value="c1s1">Cycle 1 Session 1</option>
        <option value="c1s2">Cycle 1 Session 2</option>
        <option value="c1s3">Cycle 1 Session 3</option>
        <option value="c2s1">Cycle 2 Session 1</option>
      </select>
      <span class="hint">Select a set to auto-load the Word List.</span>
    </div>

    <div class="steps" id="stepsPanel">
      <h3>Spelling Steps</h3>
      <div id="script" class="script">
        <div class="line current" id="L0">watch me spell some words. remember how i do it. you will have to do it later.</div>
        <div class="line" id="La">a) <span class="em">say</span> the word, give the meaning in a sentence, and repeat the word.</div>
        <div class="line" id="Lb">b) i track the syllables.</div>
        <div class="line" id="Lc1">c) i track and spell the sounds in each syllable.</div>
        <div class="line" id="Ld">(d) <span class="em">blend</span> and check syllable. i write it in the syllable cell.</div>
        <div class="line" id="Le">(e) repeat for next syllable.</div>
        <div class="line" id="Lf">(f) <span class="em">blend</span> and check whole word.</div>
      </div>
    </div>

    <div id="instruction" aria-live="polite">
      open teacher panel (<span class="kbd">ctrl</span>+<span class="kbd">alt</span>+<span class="kbd">t</span> or the tiny dot). load tiles (or choose a lesson set above), then ‚Äúbegin‚Äù.
    </div>

    <div class="controls">
      <button id="beginBtn"  onclick="begin()">Begin</button>
      <button id="nextBtn"   onclick="nextStep()" disabled>Next Step</button>
      <button id="restartBtn"onclick="restart()">Restart</button>
      <button class="secondary" id="toggleInstructionsBtn" onclick="toggleInstructions()">Hide Instructions</button>
      <button class="secondary" id="toggleVoiceBtn" onclick="toggleVoice()">Mute Voice</button>
    </div>

    <div id="studentLayout"></div>

    <h3 style="margin:12px 0 6px;font-size:18px">Counters</h3>
    <div class="counter-tray" id="counters" ondrop="dropToTray(event)" ondragover="allowDropBasic(event)">
      <div class="counter locked" id="seedCounter" draggable="true" ondragstart="dragSpawn(event)" title="drag to create a counter"></div>
    </div>

    <button id="teacherHotspot" class="teacher-hotspot" aria-label="open teacher panel"></button>
  </div>
</div>

<div class="teacher-panel" id="teacherPanel" aria-hidden="true">
  <h4>Teacher tools</h4>
  <div class="hint">toggle panel: <span class="kbd">ctrl</span>+<span class="kbd">alt</span>+<span class="kbd">t</span> or click the dot.</div>
</div>

<div class="credits">
  <p>¬© 2025 lim kim sze. <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener">cc by-nc-nd 4.0</a></p>
</div>

<script>
  /* =========================================================
     ‚úÖ RELIABLE BASES
     - Primary: SAME GitHub Pages origin (no CORS, most reliable on mobile)
     - Fallback: jsDelivr CDN
     ========================================================= */
  const GHP_BASE = new URL("./", location.href).href;  // folder containing this HTML
  const CDN_BASE = "https://cdn.jsdelivr.net/gh/limkimsze-maker/P3_SDR_Spelling@main/";

  function urlGhp(path){ return new URL(path, GHP_BASE).href; }
  function urlCdn(path){ return new URL(path, CDN_BASE).href; }

  // lesson files are in the SAME folder as index.html (repo root GH Pages)
  const LESSON_FILES = {
    c1s1: "Cycle 1 Session 1.json",
    c1s2: "Cycle 1 Session 2.json",
    c1s3: "Cycle 1 Session 3.json",
    c2s1: "Cycle 2 Session 1.json",
  };

  function lessonUrlPrimary(key){ return urlGhp(LESSON_FILES[key]); }
  function lessonUrlFallback(key){ return urlCdn(encodeURIComponent(LESSON_FILES[key]).replace(/%20/g,"%20")); }

  // sounds folder is in SAME site first
  function soundUrlPrimary(token){ return urlGhp("sounds/" + encodeURIComponent(token) + ".m4a"); }
  function soundUrlFallback(token){ return urlCdn("sounds/" + encodeURIComponent(token) + ".m4a"); }

  /* =========================================================
     üîá Silent background prefetch (same-origin)
     ========================================================= */
  const _prefetchedLessons = new Set();
  function prefetchLessonSilently(key){
    if(!key || _prefetchedLessons.has(key) || !LESSON_FILES[key]) return;
    const u = lessonUrlPrimary(key);
    fetch(u, { cache: "force-cache" }).then(r => r.ok ? r.text() : null).then(()=> {
      _prefetchedLessons.add(key);
    }).catch(()=>{});
  }

  /* ===== Fit stage ===== */
  (function(){
    let W=0,H=0,stage=document.getElementById('stage');
    function measure(){ stage.style.transform='none'; W=stage.offsetWidth; H=stage.offsetHeight; }
    function fit(){ if(!W||!H) measure(); const s=Math.min((innerWidth-2)/W,(innerHeight-2)/H); stage.style.transform='scale('+s+')'; }
    addEventListener('load',()=>requestAnimationFrame(()=>{ measure(); fit(); refreshTable(); setCountersLocked(true); lockAllSoundSlots(); autoFitDisplayToWord(); }));
    addEventListener('resize',fit); addEventListener('orientationchange',()=>setTimeout(fit,50));
  })();

  /* ===== Teacher panel toggle + keyboard shortcut ===== */
  function toggleTeacherPanel(force){
    const panel=document.getElementById('teacherPanel');
    const show=(typeof force==='boolean')?force:panel.style.display!=='block';
    panel.style.display=show?'block':'none';
    panel.setAttribute('aria-hidden', show?'false':'true');
  }
  addEventListener('keydown', (e) => {
    const isT = (e.code === 'KeyT') || (e.key && e.key.toLowerCase() === 't');
    if (e.ctrlKey && e.altKey && isT) { e.preventDefault(); e.stopPropagation(); toggleTeacherPanel(); }
  });
  addEventListener('load',()=>{
    document.getElementById('teacherHotspot').addEventListener('click',()=>toggleTeacherPanel());

    // ‚úÖ warm up lessons in background (silent)
    Object.keys(LESSON_FILES).forEach((k, i) => {
      setTimeout(() => prefetchLessonSilently(k), 500 + i*180);
    });
  });

  /* ===== Instructions + voice ===== */
  let instructionsHidden=false;
  let voiceEnabled=true;
  let BLOCK_TTS=false;

  function toggleInstructions(){
    instructionsHidden=!instructionsHidden;
    const steps=document.getElementById('stepsPanel');
    const bar=document.getElementById('instruction');
    steps.style.display = instructionsHidden ? 'none' : 'block';
    bar.style.display   = instructionsHidden ? 'none' : 'block';
    document.getElementById('toggleInstructionsBtn').textContent =
      instructionsHidden ? 'Show Instructions' : 'Hide Instructions';
    requestAnimationFrame(()=>{ const evt=new Event('resize'); window.dispatchEvent(evt); });
  }
  function toggleVoice(){
    voiceEnabled=!voiceEnabled;
    document.getElementById('toggleVoiceBtn').textContent = voiceEnabled ? 'Mute Voice' : 'Unmute Voice';
    if(!voiceEnabled && window.speechSynthesis){ speechSynthesis.cancel(); }
  }
  function setInstruction(text, speakNow=true){
    const el=document.getElementById('instruction');
    el.textContent = text || '';
    if(speakNow && voiceEnabled) tts(text);
  }
  function setCurrentLine(id){
    document.querySelectorAll('.steps .line').forEach(el=>el.classList.remove('current'));
    const el=document.getElementById(id); if(el) el.classList.add('current');
  }
  function tts(text, cb){
    if (!text || BLOCK_TTS || !voiceEnabled || !window.speechSynthesis) { cb && cb(); return; }
    const u = new SpeechSynthesisUtterance(text);
    u.onend = ()=> cb && cb();
    u.onerror = ()=> cb && cb();
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  /* =========================================================
     ‚úÖ Token Audio: primary GH Pages + cache-bust, fallback CDN
     ========================================================= */
  function playAudio(url, cb, fallbackToken){
    const audio = new Audio(url);
    audio.onended = ()=> cb && cb();
    audio.onerror = ()=> {
      if (fallbackToken && !BLOCK_TTS) tts('/' + fallbackToken + '/', cb);
      else cb && cb();
    };
    audio.play().catch(()=> {
      if (fallbackToken && !BLOCK_TTS) tts('/' + fallbackToken + '/', cb);
      else cb && cb();
    });
  }
  async function playSoundForToken(token, cb){
    const k = (token || '').toLowerCase().trim();
    if(!k){ cb && cb(); return; }

    const buster = "v=" + Date.now();
    const u1 = soundUrlPrimary(k) + (soundUrlPrimary(k).includes("?")?"&":"?") + buster;
    const u2 = soundUrlFallback(k) + (soundUrlFallback(k).includes("?")?"&":"?") + buster;

    // try primary first
    const a = new Audio();
    a.src = u1;
    a.onended = ()=> cb && cb();
    a.onerror = ()=>{
      playAudio(u2, cb, k);
    };
    a.play().catch(()=>{
      playAudio(u2, cb, k);
    });
  }

  /* ===== Display map ===== */
  const TOKEN_DISPLAY_MAP = {
    "a_":"a","a__":"a","c_":"c","e_":"e","e__":"e","i__":"i","i_":"i","o__":"o","u__":"u","u_":"u","u":"u",
    "th":"th","th_":"th","ss":"ss","ff":"ff","ll":"ll","oo":"oo","oo_":"oo","ow":"ow","ow_":"ow","ea_":"ea","ea__":"ea"
  };
  function displayToken(t){
    const k = String(t||"").trim().toLowerCase();
    if (k in TOKEN_DISPLAY_MAP) return TOKEN_DISPLAY_MAP[k];
    return k.replace(/_/g,"");
  }

  function tokenSpan(tok){
    const k = String(tok||"").trim().toLowerCase();
    return (k === 'x') ? 2 : 1;
  }

  /* ===== Lesson data (defaults) ===== */
  let words = [{ word:"map", meaning:"a map shows places.", syllables:[{letters:["m","a","p"]}] }];
  let teacherSet = JSON.parse(JSON.stringify(words));

  /* ===== Student layout ===== */
  let DISPLAY_SYL = 1;

  function renderLayout(){
    const container=document.getElementById('studentLayout');
    container.innerHTML='';
    const displaySyl = Math.max(1, Math.min(4, parseInt(DISPLAY_SYL||1,10)));
    const COLS = `repeat(${displaySyl}, minmax(0,1fr)) 1.1fr`;

    const grid=document.createElement('div'); grid.className='grid';

    const hdr=document.createElement('div'); hdr.className='hdr';
    hdr.style.gridTemplateColumns = COLS;
    for(let s=1;s<=displaySyl;s++){
      const d=document.createElement('div');
      d.textContent = (s===1?'first':s===2?'second':s===3?'third':'fourth')+' syllable';
      hdr.appendChild(d);
    }
    const wholeHdr=document.createElement('div'); wholeHdr.textContent='whole word';
    hdr.appendChild(wholeHdr);
    grid.appendChild(hdr);

    const row=document.createElement('div'); row.className='row';
    row.style.gridTemplateColumns = COLS;
    for(let s=1;s<=displaySyl;s++){
      const cell=document.createElement('div'); cell.className='cell'; cell.id='syllable'+s;
      const drop=document.createElement('div'); drop.className='syllableDrop'; drop.id='syldrop'+s;
      drop.setAttribute('ondrop','dropSyllable(event,'+s+')');
      drop.setAttribute('ondragover','allowDropBasic(event)');
      cell.appendChild(drop); row.appendChild(cell);
    }
    const wholeCell=document.createElement('div'); wholeCell.className='cell wholeword-write';
    const wholeText=document.createElement('div'); wholeText.id='wholewordText';
    wholeCell.appendChild(wholeText); row.appendChild(wholeCell);
    grid.appendChild(row);

    const tilesRow=document.createElement('div'); tilesRow.className='tiles-row';
    tilesRow.style.gridTemplateColumns = COLS;

    for(let s=1;s<=displaySyl;s++){
      const tiles=document.createElement('div'); tiles.className='tiles';
      for(let t=0;t<6;t++){
        const slot=document.createElement('div');
        slot.className='counter-slot disabled';
        slot.dataset.allow='0';
        slot.id='s'+s+'t'+t;
        slot.dataset.ord = (t+1);
        slot.setAttribute('ondrop','dropSound(event,'+s+','+t+')');
        slot.setAttribute('ondragover','allowDropSound(event)');
        tiles.appendChild(slot);
      }
      tilesRow.appendChild(tiles);
    }
    tilesRow.appendChild(document.createElement('div'));
    grid.appendChild(tilesRow);

    container.appendChild(grid);
  }

  function autoFitDisplayToWord(){
    const w = (words[wIndex] || words[0]);
    DISPLAY_SYL = Math.max(1, Math.min(4, (w?.syllables || [{letters:[]}]).length));
    renderLayout();
  }

  /* ===== Word table (kept minimal here; your original full table logic can stay) ===== */
  function refreshTable(){ /* keep your existing refreshTable if you want; not needed to load lessons */ }

  function deepCopy(x){ return JSON.parse(JSON.stringify(x)); }
  function normalizeWordSet(arr){
    return (arr||[]).map(w=>({
      word: String(w.word||'').trim(),
      meaning: String(w.meaning||'').trim(),
      syllables: (Array.isArray(w.syllables)? w.syllables : [])
        .slice(0,4)
        .map(s=>({
          letters: Array.isArray(s.letters) ? s.letters.slice(0,6).map(t=>String(t||'').toLowerCase()) : []
        }))
    })).filter(w => w.word);
  }

  /* ===== Slot guards ===== */
  function lockAllSoundSlots(){
    document.querySelectorAll('.counter-slot').forEach(s=>{
      s.classList.add('disabled');
      s.classList.remove('span-ghost');
      s.dataset.allow='0';
      delete s.dataset.tokenIndex;
      delete s.dataset.span;
      delete s.dataset.spanGhost;
      delete s.dataset.spanParent;
    });
  }

  function guardSoundSlots(activeSylIndex, tokens){
    lockAllSoundSlots();
    const toks = (tokens||[]).slice(0,6);
    let cursor = 0;

    for (let i=0; i<toks.length && cursor<6; i++){
      const tok = toks[i];
      let span = tokenSpan(tok);
      if (span === 2 && cursor+1 >= 6) span = 1;

      const start = document.getElementById(`s${activeSylIndex}t${cursor}`);
      if (!start) break;

      start.classList.remove('disabled');
      start.dataset.allow = '1';
      start.dataset.tokenIndex = String(i);
      start.dataset.span = String(span);

      if (span === 2){
        const ghost = document.getElementById(`s${activeSylIndex}t${cursor+1}`);
        if (ghost){
          ghost.classList.add('span-ghost');
          ghost.dataset.spanGhost = '1';
          ghost.dataset.spanParent = start.id;
        }
      }

      cursor += span;
    }
  }

  /* ===== Drag gating ===== */
  let ALLOW_DRAG=false;
  function setCountersLocked(locked){
    document.querySelectorAll('.counter').forEach(c=>c.classList.toggle('locked', locked));
  }

  /* ===== Flow state ===== */
  let step=0, wIndex=0, activeSyllable=1;
  let needSyllableDrops=0, syllableDropsDone=0;
  let needSoundDrops=0, soundDropsDone=0;

  function addTileLabel(slotEl, text){
    if (slotEl.querySelector('.tile-label')) return;
    const lbl = document.createElement('div');
    lbl.className = 'tile-label';
    const span = Math.max(tokenSpan(text), parseInt(slotEl.dataset.span || '1', 10));
    if (span === 2) lbl.classList.add('span2');
    lbl.textContent = displayToken(text || "");
    slotEl.appendChild(lbl);
  }

  /* ===== Desktop drag spawn ===== */
  function dragSpawn(ev){
    if(!ALLOW_DRAG || ev.target.classList.contains('locked')){
      ev.preventDefault(); return;
    }
    const seed=ev.target, clone=seed.cloneNode(true);
    clone.id='c'+Math.random().toString(36).slice(2,8);
    clone.addEventListener('dragstart',dragSpawn);
    document.getElementById('counters').appendChild(clone);
    ev.dataTransfer.setData('text', clone.id);
  }
  function allowDropBasic(ev){
    if (!ALLOW_DRAG) return;
    ev.preventDefault();
    ev.dataTransfer.dropEffect = 'move';
  }
  function allowDropSound(ev){
    if (!ALLOW_DRAG) return;
    const ok = ev.currentTarget?.dataset?.allow === '1';
    if (ok){ ev.preventDefault(); ev.dataTransfer.dropEffect='move'; }
    else { ev.dataTransfer.dropEffect='none'; }
  }
  function dropToTray(ev){
    if(!ALLOW_DRAG){ ev.preventDefault(); return; }
    ev.preventDefault();
    const id=ev.dataTransfer.getData('text');
    const el=document.getElementById(id);
    if(el){
      el.classList.remove('in-slot');
      el.style.left = el.style.top = el.style.transform = el.style.position = el.style.zIndex = '';
      ev.currentTarget.appendChild(el);
    }
  }
  function dropSyllable(ev,which){
    if(!ALLOW_DRAG){ ev.preventDefault(); return; }
    ev.preventDefault();
    if(needSyllableDrops<=0) return;
    const id=ev.dataTransfer.getData('text');
    const host=ev.currentTarget;
    if(!host.hasChildNodes()){
      host.appendChild(document.getElementById(id));
      syllableDropsDone++;
      if(syllableDropsDone>=needSyllableDrops){
        setInstruction("syllables tracked ‚Äî start with 1st syllable sounds.", false);
        startSyllableTrack(1);
      }
    }
  }
  function dropSound(ev, syll, tile){
    if(!ALLOW_DRAG){ ev.preventDefault(); return; }
    const host = ev.currentTarget;
    if (host?.dataset?.allow !== '1'){ ev.preventDefault(); return; }
    ev.preventDefault();
    if(needSoundDrops<=0 || syll!==activeSyllable) return;

    const id = ev.dataTransfer.getData('text');
    const counterEl = document.getElementById(id);
    if(!counterEl || host.hasChildNodes()) return;

    host.appendChild(counterEl);
    host.classList.add('has-counter');
    counterEl.classList.add('in-slot');

    const w = words[wIndex];
    const sylLetters = (w.syllables?.[syll-1]?.letters) || [];
    const tokenIndex = parseInt(host.dataset.tokenIndex || String(tile), 10);
    const token = sylLetters[tokenIndex];

    const span = parseInt(host.dataset.span || '1', 10);
    host.dataset.span = String(span);

    if (span === 2){
      counterEl.style.left = '100%';
      const ghost = document.getElementById(`s${syll}t${tile+1}`);
      if (ghost) ghost.classList.add('has-counter');
    } else {
      counterEl.style.left = '';
    }

    if(token){
      playSoundForToken(token, ()=> addTileLabel(host, token));
    }

    soundDropsDone++;
  }

  function enterNoTTSPhase(){ BLOCK_TTS = true; if (window.speechSynthesis) speechSynthesis.cancel(); }
  function exitNoTTSPhase(){ BLOCK_TTS = false; }
  function ordinal(n){ return n===1?'1st':n===2?'2nd':n===3?'3rd':'4th'; }

  function startSyllableTrack(n){
    activeSyllable=n; soundDropsDone=0;
    enterNoTTSPhase();
    const w=words[wIndex];
    const sylLetters=(w.syllables?.[n-1]?.letters)||[];
    needSoundDrops=Math.min(6,sylLetters.length);
    ALLOW_DRAG = true;
    setCountersLocked(false);
    guardSoundSlots(n, sylLetters);
    setInstruction(`${ordinal(n)} syllable ‚Äî track the sounds: place counters on the tiles (left‚Üíright).`, false);
  }

  function resetBoard(){
    const ww=document.getElementById('wholewordText'); if(ww) ww.textContent='';
    document.querySelectorAll('[id^=syldrop]').forEach(n=>{ n.innerHTML=''; });
    document.querySelectorAll('.counter-slot').forEach(s=>{ s.innerHTML=''; s.classList.remove('has-counter'); });
    document.querySelectorAll('.syllableText').forEach(e=>e.remove());
    lockAllSoundSlots();
  }

  function begin(){
    document.getElementById('beginBtn').disabled=true;
    document.getElementById('nextBtn').disabled=false;
    step=0; activeSyllable=1;
    autoFitDisplayToWord();
    resetBoard();
    ALLOW_DRAG = false; setCountersLocked(true); lockAllSoundSlots();
    nextStep();
  }
  function restart(){
    document.getElementById('beginBtn').disabled=false;
    document.getElementById('nextBtn').disabled=true;
    step=0; wIndex=0; activeSyllable=1;
    resetBoard();
    setInstruction('choose a lesson set above, then begin.');
    exitNoTTSPhase();
    ALLOW_DRAG=false; setCountersLocked(true); lockAllSoundSlots();
    autoFitDisplayToWord();
  }
  function nextStep(){
    const w=words[wIndex];
    const sylCount=Math.min(4, Math.max(1, (w.syllables||[{letters:[]}]).length));

    switch(step){
      case 0:
        setInstruction("watch me spell some words.");
        ALLOW_DRAG = false; setCountersLocked(true); lockAllSoundSlots();
        break;
      case 1:
        setInstruction(`say the word.`, false);
        tts(`say the word ${w.word}`, ()=> document.getElementById('nextBtn').disabled=false);
        break;
      case 2:
        setInstruction("i track the syllables. put one counter in each syllable box.");
        needSyllableDrops=sylCount; syllableDropsDone=0;
        document.getElementById('nextBtn').disabled=true;
        ALLOW_DRAG = true; setCountersLocked(false); lockAllSoundSlots();
        break;
    }
    step++;
  }

  /* =========================================================
     ‚úÖ ROBUST LESSON LOADER (fixes your screenshot)
     - try same-origin GH Pages first (best)
     - if fail: try jsDelivr CDN
     - auto retry (3 tries) before showing error
     ========================================================= */
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function fetchJsonWithRetry(url, tries=3){
    let lastErr=null;
    for(let i=0;i<tries;i++){
      try{
        const res = await fetch(url, { cache:'no-store', headers:{'Cache-Control':'no-cache'} });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(e){
        lastErr=e;
        await sleep(250 * (i+1)); // backoff
      }
    }
    throw lastErr || new Error("fetch failed");
  }

  async function onLessonChange(key){
    if(!key){
      setInstruction("choose a lesson set above.", false);
      return;
    }
    if(!LESSON_FILES[key]){
      alert("Lesson URL not configured.");
      return;
    }

    setInstruction("loading lesson‚Ä¶", false);

    // ‚úÖ cache-bust for ‚Äúlatest‚Äù
    const bust = "v=" + Date.now();
    const u1 = lessonUrlPrimary(key) + (lessonUrlPrimary(key).includes("?")?"&":"?") + bust;
    const u2 = lessonUrlFallback(key) + (lessonUrlFallback(key).includes("?")?"&":"?") + bust;

    try{
      // try same-origin first
      let obj = await fetchJsonWithRetry(u1, 3);
      if(!obj || !Array.isArray(obj.words)) throw new Error('invalid json: missing "words" array');

      teacherSet = normalizeWordSet(obj.words);
      words = teacherSet.map(deepCopy);
      wIndex=0;
      autoFitDisplayToWord();

      document.getElementById('beginBtn').disabled=false;
      document.getElementById('nextBtn').disabled=true;

      setInstruction(`lesson loaded (${teacherSet.length} words). click ‚Äúbegin‚Äù.`, false);
      return;
    }catch(e1){
      try{
        // fallback to CDN
        let obj = await fetchJsonWithRetry(u2, 3);
        if(!obj || !Array.isArray(obj.words)) throw new Error('invalid json: missing "words" array');

        teacherSet = normalizeWordSet(obj.words);
        words = teacherSet.map(deepCopy);
        wIndex=0;
        autoFitDisplayToWord();

        document.getElementById('beginBtn').disabled=false;
        document.getElementById('nextBtn').disabled=true;

        setInstruction(`lesson loaded (${teacherSet.length} words). click ‚Äúbegin‚Äù.`, false);
        return;
      }catch(e2){
        alert(
          "Could not load the lesson.\n\n" +
          "Likely cause: mobile webview blocked CDN/CORS.\n\n" +
          "Fix: This build now prefers same-origin GitHub Pages first.\n" +
          "If you still see this, check if the JSON file exists in your GitHub Pages folder."
        );
        setInstruction("lesson load failed.", false);
        console.warn("Primary failed:", e1);
        console.warn("Fallback failed:", e2);
      }
    }
  }

  // expose
  window.onLessonChange = onLessonChange;
  window.prefetchLessonSilently = prefetchLessonSilently;
  window.allowDropBasic=allowDropBasic;
  window.allowDropSound=allowDropSound;
  window.dropToTray=dropToTray;
  window.dropSyllable=dropSyllable;
  window.dropSound=dropSound;
  window.dragSpawn=dragSpawn;
  window.begin=begin;
  window.nextStep=nextStep;
  window.restart=restart;
  window.toggleInstructions=toggleInstructions;
  window.toggleVoice=toggleVoice;
</script>
</body>
</html>
